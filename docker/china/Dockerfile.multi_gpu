# Use DaoCloud mirrored vllm image for China region for multi-GPU with Ampere architecture and above (Compute Capability>=8.0)
# Compute Capability version query (https://developer.nvidia.com/cuda-gpus)
FROM docker.m.daocloud.io/vllm/vllm-openai:v0.10.1.1

# Use the official vllm image
# FROM vllm/vllm-openai:v0.10.1.1

# Use DaoCloud mirrored vllm image for China region for multi-GPU with Turing architecture and below (Compute Capability<8.0)
# FROM docker.m.daocloud.io/vllm/vllm-openai:v0.10.2

# Use the official vllm image
# FROM vllm/vllm-openai:v0.10.2

# Install libgl for opencv support & Noto fonts for Chinese characters
RUN apt-get update && \
    apt-get install -y \
        fonts-noto-core \
        fonts-noto-cjk \
        fontconfig \
        libgl1 && \
    fc-cache -fv && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install mineru latest
RUN python3 -m pip install -U 'mineru[core]' -i https://mirrors.aliyun.com/pypi/simple --break-system-packages && \
    python3 -m pip install litserve --break-system-packages && \
    python3 -m pip cache purge

# Download models and update the configuration file
RUN /bin/bash -c "mineru-models-download -s modelscope -m all"

# Copy multi-GPU server files
RUN mkdir -p /app/multi_gpu_v2
COPY projects/multi_gpu_v2/server.py /app/multi_gpu_v2/
COPY projects/multi_gpu_v2/_config_endpoint.py /app/multi_gpu_v2/

# Create output directory for the server
RUN mkdir -p /tmp/mineru_output && \
    chmod -R 777 /tmp/mineru_output

# Set environment variables for multi-GPU
ENV MINERU_MODEL_SOURCE=local
ENV MINERU_DEVICE_MODE=auto

# Expose port 8000 for the API server
EXPOSE 8000

# Default command runs the multi-GPU server
# You can override with docker run by passing a different command
# For custom workers_per_device, use: --workers-per-device=N
ENTRYPOINT ["python3"]
CMD ["/app/multi_gpu_v2/server.py"]
